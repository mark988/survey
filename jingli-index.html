<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>OZHouse Questionnaires</title>
  <!-- CSS files -->
  <link href="./dist/css/tabler.min.css" rel="stylesheet" />
  <link href="./dist/css/demo.min.css" rel="stylesheet" />
  <style>
    @import url('https://rsms.me/inter/inter.css');
    :root {
      --tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
    }

    body {
      font-feature-settings: "cv03", "cv04", "cv11";
    }

    /* 遮罩层样式 */
    .mask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto; /* 遮罩可阻止点击穿透 */
    }
    
    .mask-box {
      width: 320px;
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      text-align: center;
      color: #333;
    }
    
    .hidden { display: none; }

    /* 当页面提交中，禁用整个页面的控件 */
    body.submitting *:not(#submit-mask) {
      pointer-events: none; /* 禁止鼠标点击、输入 */
      user-select: none;    /* 禁止文字选中 */
      opacity: 0.6;         /* 页面控件半透明提示 */
    }
  </style>
</head>

<body>
  <div id="submit-mask" class="mask hidden">
    <div class="mask-box">
      <div class="mb-2">Submitting...</div>
      <div class="progress">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="dist/js/sweetalert2.all.min.js"></script>
  <script src="dist/js/common.js"></script>
  <script src="dist/js/spin.min.js"></script>

  <div class="page">
    <header class="navbar-expand-md"></header>
    <div class="page-wrapper">
      <div class="page-body" style="margin-top:8px">
        <div class="container-xl">
          <div class="row row-cards justify-content-center">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header text-center">
                  <h1 class="card-title">Questionnaires</h1>
                </div>

                <div class="card-body">
                  <!-- 说明文字 -->
                  <div class="mb-3">
                    <p>Manager Evaluation Survey (Anonymous)</p>
                    <p>Rating Scale: 1 = Strongly Disagree, 2 = Disagree, 3 = Neutral, 4 = Agree, 5 = Strongly Agree</p>
                  </div>

                  <!-- 选择语言 -->
                  <div class="mb-3">
                    <label class="form-label">SELECT LANGUAGE</label>
                    <select id="select-countries" class="form-select">
                      <option value="1">EN</option>
                      <option value="2">Burmese</option>
                    </select>
                  </div>

                  <!-- 选择参与者 -->
                  <div class="mb-3">
                    <label class="form-label required">PLEASE SELECT ONE NAME</label>
                    <div id="employee"></div>
                  </div>

                  <hr>
                  <!-- 问题显示区域 -->
                  <div id="firstDiv"></div>
                  <div id="result"></div>
                </div>

                <div class="card-footer text-center">
                  <button id="submitBtn" class="btn btn-primary" onclick="submitSurvey()">Submit</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <footer class="footer footer-transparent d-print-none"></footer>
    </div>
  </div>

  <script>
    // 全局变量
    var questionNum = 0; // 问题总数
    var submitting = false; // 是否正在提交，避免重复提交

    // 初始化 Spinner
    var spinner = new Spinner({
      lines: 13, length: 0, width: 10, radius: 30, color: '#0054a6',
      speed: 1, trail: 60, className: 'spinner', zIndex: 9999
    });

    /**
     * 显示遮罩层
     */
    function showMask() {
      updateProgress(0);
      document.getElementById('submit-mask').classList.remove('hidden');
      document.body.classList.add('submitting'); // 禁止整个页面操作
    }

    /**
     * 隐藏遮罩层
     */
    function hideMask() {
      document.getElementById('submit-mask').classList.add('hidden');
      document.body.classList.remove('submitting'); // 恢复操作
    }

    /**
     * 更新遮罩层进度
     * @param {number} percent 进度百分比 0-100
     */
    function updateProgress(percent) {
      const bar = document.getElementById('progress-bar');
      bar.style.width = percent + '%';
      bar.innerText = percent + '%';
    }

    /**
     * 加载问题数据
     */
    function loadData(languageId) {
      $("#result").empty();

      ajaxRequest("GET", server + "/question/answer/queryjingli?countries=" + languageId, null, true, function(response) {
        if (response.code === 0) {
          let dataArray = response.data;
          questionNum = dataArray.length;
          let html = "";

          for (let i = 0; i < questionNum; i++) {
            let q = dataArray[i];
            html += "<div class='mb-3'>";
            html += `<p class='form-label' style='font-weight:600;' id='${q.qid}'>${q.title}</p>`;
            html += "<div>";
            q.content.split("，").forEach(function(item){
              let arr = item.split("-");
              html += `<label class='form-check form-check-inline'>
                         <input type='radio' class='form-check-input' name='a${q.qid}' value='${arr[0]}'>
                         <span class='form-check-label'>${arr[1]}</span>
                       </label>`;
            });
            html += "</div></div>";
          }

          $("#result").html(html);
        }
      }, function() {
        Swal.fire('Error', 'Failed to load questions', 'error');
      });
    }

    /**
     * 加载员工列表
     */
    function loadEmployee() {
      $("#employee").empty();
      ajaxRequest("GET", server + "/employee/selectList", null, true, function(response){
        let html = "";
        response.data.forEach(function(emp, index){
          html += `<label class='form-check form-check-inline'>
                     <input type='radio' class='form-check-input' name='radios-inline' ${index===0?'checked':''} value='${index}'>
                     <span class='form-check-label'>${emp.name}</span>
                   </label>`;
        });
        $("#employee").html(html);
      }, function(){ Swal.fire('Error','Failed to load employees','error'); });
    }

    /**
     * 提交问卷
     */
    function submitSurvey() {
      if (submitting) return;
      submitting = true;

      // 获取已选题目答案
      let answers = $('input[type="radio"]:checked[name^="a"]').map(function(){ return this.value; }).get();
      if (answers.length !== questionNum) {
        Swal.fire('Tips', 'You have unanswered questions, please check.', 'info');
        submitting = false;
        return;
      }

      // 获取选中的参与者姓名
      let participantName = $('input[name="radios-inline"]:checked').next('span').text();
      if (!participantName) {
        Swal.fire('Tips', 'Please select a participant.', 'info');
        submitting = false;
        return;
      }

      // 获取所有题目ID
      let qid = $('p[id]').map(function(){ return $(this).attr('id'); }).get();

      // 构建提交数据
      let data = { participants: participantName, qid: qid.join(','), anwser: answers.join(',') };

      // 显示遮罩
      showMask();

      let percent = 0;
      const timer = setInterval(()=>{
        percent = Math.min(percent+10,90);
        updateProgress(percent);
      },300);

      ajaxRequest("POST", server + "/surveyResult/add", JSON.stringify(data), true,
        function(resp) {
          clearInterval(timer);
          updateProgress(100);
          setTimeout(()=>{
            hideMask();
            submitting = false;
            if (resp.code === 0) {
              Swal.fire({ title: 'Submit Successfully', icon: 'success', confirmButtonText: 'OK' }).then(()=> location.reload());
            } else {
              Swal.fire('Tips', resp.message, 'info');
            }
          },500);
        },
        function(jqXHR, textStatus) {
          clearInterval(timer);
          hideMask();
          submitting = false;
          Swal.fire('Tips', textStatus, 'info');
        }
      );
    }

    // 页面初始化
    $(document).ready(function(){
      loadEmployee();
      loadData(1);

      // 切换语言时刷新问题
      $('#select-countries').change(function(){
        let langId = $(this).val();
        loadData(langId);
      });
    });
  </script>
</body>
</html>
