<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title>OZHouse Questionnaires</title>

  <!-- CSS files -->
  <link href="./dist/css/tabler.min.css" rel="stylesheet"/>
  <link href="./dist/css/tabler-flags.min.css" rel="stylesheet"/>
  <link href="./dist/css/tabler-payments.min.css" rel="stylesheet"/>
  <link href="./dist/css/tabler-vendors.min.css" rel="stylesheet"/>
  <link href="./dist/css/demo.min.css" rel="stylesheet"/>

  <style>
    @import url('https://rsms.me/inter/inter.css');
    :root {
      --tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
    }
    body { font-feature-settings: "cv03", "cv04", "cv11"; }

    /* 遮罩样式 */
    .mask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mask-box {
      width: 320px;
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      text-align: center;
    }
    .hidden { display: none; }

    /* 按钮徽章修正 */
    .btn-participant {
      position: relative;
      display: inline-block;
      margin: 4px;
      --tblr-btn-font-size: 0.8rem;
    }
    .btn-participant .spanBadge {
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: 0.65rem;
      line-height: 1;
      padding: 2px 5px;
    }
    .selected-participant {
      box-shadow: 0 0 6px #0054a6;
      border: 2px solid #0054a6;
      transition: all 0.2s ease;
    }

    /* 禁用表单控件 */
    .disabled-form * {
      pointer-events: none !important;
      opacity: 0.6;
    }
  </style>
</head>
<body>

<div class="page" id="page">
  <div class="page-wrapper">
    <div class="page-body" style="margin-top:8px">
      <div class="container-xl">
        <div class="row row-cards justify-content-center">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header text-center">
                <h1 class="card-title">Questionnaires Result</h1>
              </div>
              <div class="card-body">
                <div class="mb-3 row">
                  <label class="form-label required">SELECT A DATE</label>
                  <div class="row g-2">
                    <div class="col-5">
                      <select id="month" name="user[month]" class="form-select">
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                      </select>
                    </div>
                    <div class="col-auto">
                      <button class="btn btn-primary" onclick="query()">Query</button>
                      <button class="btn btn-danger" onclick="deleteSurveyResult()">Delete</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card-body" id="badgeCode" style="margin-bottom:12px;"></div>
              <div class="card-body" id="result" style="padding:0;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 遮罩 + 进度条 -->
  <div id="submit-mask" class="mask hidden">
    <div class="mask-box">
      <div class="mb-2">Loading...</div>
      <div class="progress">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
      </div>
    </div>
  </div>
</div>

<!-- JS文件 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="./dist/js/sweetalert2.all.min.js"></script>
<script src="dist/js/common.js"></script>
<script src="./dist/js/spin.min.js"></script>

<script>
  let questionNum = 0;
  let submitting = false;
  let selectedParticipant = null;

  const spinner = new Spinner({
    lines: 13, length: 0, width: 10, radius: 30,
    corners: 1, rotate: 0, direction: 1, color: '#0054a6',
    speed: 1, trail: 60, shadow: false, hwaccel: false,
    className: 'spinner', zIndex: 2e9, top: '50%', left: 'auto'
  });

  function updateProgress(percent){
    $('#progress-bar').css('width', percent+'%').text(percent+'%');
  }
  function showMask(){ 
    $('#page').addClass('disabled-form'); 
    $('#submit-mask').removeClass('hidden'); 
    updateProgress(0); 
  }
  function hideMask(){ 
    $('#page').removeClass('disabled-form'); 
    $('#submit-mask').addClass('hidden'); 
  }

  function queryByParticipantsOnSuccess(response){
    let timesArray = response.data.survey;
    let name  = response.data.name;
    let opDate = response.data.opDate;
    $("#result").empty();

    let divCode="<div class='col-12'><div class='card'><div class='table-responsive'><table class='table'><thead>"+
      `<tr><th></th><th colspan=3 style='text-align:right'>Name: ${name}</th>`+
      `<th colspan=7>Review Date: ${opDate}</th><th></th></tr></thead><tbody>`;
    let tbodyHtml = "", aTotal=0,bTotal=0,cTotal=0,dTotal=0,eTotal=0;

    timesArray.forEach(item=>{
      let title = item.title, title_ks=item.title_ks, content=item.answer;
      let arr=assemble(content);
      let [a,b,c,d,e]=arr;
      aTotal+=Number(a.split("-")[0]); bTotal+=Number(b.split("-")[0]);
      cTotal+=Number(c.split("-")[0]); dTotal+=Number(d.split("-")[0]);
      eTotal+=Number(e.split("-")[0]);
      tbodyHtml += `<tr><td colspan=12>${title}<br>${title_ks}</td></tr>
        <tr><td style='width:0'></td><td>${a}</td><td>${b}</td><td>${c}</td><td>${d}</td><td>${e}</td><td colspan=6></td></tr>`;
    });

    tbodyHtml += `<tr><td>Mark</td><td>5</td><td>4</td><td>3</td><td>2</td><td>1</td><td colspan=6></td></tr>`;
    let totalScore = aTotal*5+bTotal*4+cTotal*3+dTotal*2+eTotal*1;
    tbodyHtml += `<tr><td>Total</td><td>${aTotal*5}</td><td>${bTotal*4}</td><td>${cTotal*3}</td><td>${dTotal*2}</td><td>${eTotal*1}</td><td colspan=6>${totalScore}</td></tr>`;
    divCode+=tbodyHtml+"</tbody></table></div></div></div>";
    $("#result").append(divCode);

    spinner.spin();
  }

  function queryByMonthOnSuccess(response){
    let dataArray = response.data;
    $("#badgeCode").empty();
    if(dataArray.length===0){
      $("#badgeCode").append("There is no questionnaire information for this month.");
    }
    dataArray.forEach(item=>{
      let fullName = item.fullName, omitName=item.omitName, cc=item.cc;
      let btnClass = (fullName===selectedParticipant) ? "btn btn-primary selected-participant btn-participant" : "btn btn-secondary btn-participant";
      let buttonHtml = `<button onclick="getSurveyResult(this)" value="${fullName}" class="${btnClass}">${omitName}<span class="spanBadge badge bg-indigo text-indigo-fg badge-pill">${cc}</span></button>`;
      $("#badgeCode").append(buttonHtml);
    });
  }

  function getSurveyResult(button){
    selectedParticipant = $(button).val();
    $("#badgeCode button").removeClass("selected-participant btn-primary").addClass("btn-secondary").removeClass("btn-secondary");
    $(button).addClass("selected-participant btn-primary");

    let month = $('#month').val();
    loadData('2026-'+month, selectedParticipant);
  }

  function loadData(yearMonth, participants){
    let target = $("#result").get(0);
    spinner.spin(target);
    ajaxRequest("GET", server+"/surveyResult/query-yg?yearMonth="+yearMonth+"&participants="+participants,null,true, queryByParticipantsOnSuccess, ()=>spinner.spin());
  }

  function query(){
    $("#result").empty();
    let month = $('#month').val();
    let target = $("#badgeCode").get(0);
    spinner.spin(target);
    ajaxRequest("GET", server+"/surveyResult/participants-yg?yearMonth=2026-"+month,null,true, queryByMonthOnSuccess, ()=>spinner.spin());
  }

  function deleteSurveyResult(){
    const month = $('#month').val();
    const yearMonth = '2026-'+month;
    Swal.fire({
      title:'Delete Survey Result',
      text:'Enter user name to delete a specific user. Leave empty to delete ALL records of this month.',
      input:'text', showCancelButton:true, confirmButtonText:'Next', cancelButtonText:'Cancel'
    }).then(result=>{
      if(!result.isConfirmed) return;
      const name = result.value ? result.value.trim() : '';
      Swal.fire({
        title:'Confirm Delete',
        html: name?`Delete survey result of <b>${name}</b>?`:`Delete <b>ALL</b> survey results of <b>${yearMonth}</b>?`,
        icon:'warning', showCancelButton:true, confirmButtonColor:'#d33',
        confirmButtonText:'Yes, delete it', cancelButtonText:'Cancel'
      }).then(confirmRes=>{
        if(!confirmRes.isConfirmed) return;
        let target = $("#result").get(0);
        spinner.spin(target);
        let url = server + "/surveyResult/deleteSurveyResultYG";
        if(name) url += "?name=" + encodeURIComponent(name);
        ajaxRequest("GET", url, null, true, function(res){
          spinner.spin();
          if(res.code===0){
            Swal.fire('Deleted!', 'Survey result has been deleted successfully.', 'success');
            $("#result").empty(); $("#badgeCode").empty();
          }else{
            Swal.fire('Failed', res.message || 'Delete failed','error');
          }
        }, ()=>{spinner.spin(); Swal.fire('Error','Request failed','error');});
      });
    });
  }

  function assemble(str){
    let emptyArray=Array(5).fill("");
    let arr=str.split("_");
    arr.forEach(s=>{
      let tmp=s.toLowerCase();
      if(tmp.includes("always")) emptyArray[0]=s;
      if(tmp.includes("ususally")) emptyArray[1]=s;
      if(tmp.includes("sometimes")) emptyArray[2]=s;
      if(tmp.includes("rarely")) emptyArray[3]=s;
      if(tmp.includes("never")) emptyArray[4]=s;
    });
    if(!str.toLowerCase().includes("always")) emptyArray[0]="0-Always";
    if(!str.toLowerCase().includes("ususally")) emptyArray[1]="0-Ususally";
    if(!str.toLowerCase().includes("sometimes")) emptyArray[2]="0-Sometimes";
    if(!str.toLowerCase().includes("rarely")) emptyArray[3]="0-Rarely";
    if(!str.toLowerCase().includes("never")) emptyArray[4]="0-Never";
    return emptyArray;
  }

  $(document).ready(()=>{
    query();
  });
</script>

<script src="./dist/js/tabler.min.js" defer></script>
</body>
</html>
