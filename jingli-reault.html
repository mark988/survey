<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>OZHouse Questionnaires</title>
    <!-- CSS files -->
    <link href="./dist/css/tabler.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/tabler-flags.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/tabler-payments.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/tabler-vendors.min.css?1692870487" rel="stylesheet"/>
    <link href="./dist/css/demo.min.css?1692870487" rel="stylesheet"/>
    <style>
      @import url('https://rsms.me/inter/inter.css');
      :root {
        --tblr-font-sans-serif: 'Inter Var', -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
      body { font-feature-settings: "cv03", "cv04", "cv11"; }

      /* 遮罩样式 */
      .mask {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mask-box {
        width: 320px;
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        text-align: center;
      }
      .hidden { display: none; }

      /* 按钮徽章修正 */
      .btn-participant {
        position: relative;
        display: inline-block;
        margin: 4px;
        --tblr-btn-font-size: 0.8rem;
      }
      .btn-participant .spanBadge {
        position: absolute;
        top: -6px;
        right: -6px;
        font-size: 0.65rem;
        line-height: 1;
        padding: 2px 5px;
      }
      .selected-participant {
        box-shadow: 0 0 6px #0054a6;
        border: 2px solid #0054a6;
        transition: all 0.2s ease;
      }

      /* 禁用表单控件 */
      .disabled-form * {
        pointer-events: none !important;
        opacity: 0.6;
      }

      /* 结果区域加载状态 */
      .result-loading {
        position: relative;
        opacity: 0.6;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="dist/js/sweetalert2.all.min.js"></script>
    <script src="dist/js/common.js"></script>
    <script>
      // 页面全局变量
      var blue='bg-blue text-blue-fg', azure='bg-azure text-azure-fg', indigo='bg-indigo text-indigo-fg';
      var purple='bg-purple text-purple-fg', pink='bg-pink text-pink-fg', red='bg-red text-red-fg';
      var orange='bg-orange text-orange-fg', yellow='bg-yellow text-yellow-fg', lime='bg-lime text-lime-fg';
      var green='bg-green text-green-fg', teal='bg-teal text-teal-fg', cyan='bg-cyan text-cyan-fg';
    </script>

    <div class="page" id="page">
      <!-- Navbar -->
      <header class="navbar-expand-md"></header>

      <div class="page-wrapper">
        <div class="page-body" style="margin-top:8px">
          <div class="container-xl">
            <div class="row row-cards" style="display: flex; justify-content: center;">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header" style="display: flex; justify-content: center;">
                    <h1 class="card-title">Questionnaires Result</h1>
                  </div>
                  <div class="card-body">
                    <div class="mb-1 row">
                      <!-- <label class="form-label required">SELECT A DATE</label> -->
                      <div class="row g-2" style="display: flex; justify-content: right;">
                        <!-- <div class="col-5">
                        </div> -->
                        <div class="col-auto">
                          <button class="btn btn-danger" onclick="deleteSurvey()">Delete</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card-body" id="badgeCode" style="margin-bottom:12px;"></div>
                  <div class="card-body" id="result" style="padding:0;"></div>

                  <!-- 遮罩 + 进度条 -->
                  <div id="submit-mask" class="mask hidden">
                    <div class="mask-box">
                      <div class="mb-2">Loading...</div>
                      <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <footer class="footer footer-transparent d-print-none"></footer>
      </div>
    </div>

    <script src="./dist/libs/litepicker/dist/litepicker.js?1692870487" defer></script>
    <script type="text/javascript" src="dist/js/spin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.0.272/jspdf.debug.js"></script>

    <script>
      var opts = {
        lines: 13, length: 0, width: 10, radius: 30, corners: 1, rotate: 0,
        direction: 1, color: '#0054a6', speed: 1, trail: 60, shadow: false, hwaccel: false,
        className: 'spinner', zIndex: 2e9, top: '50%', left: 'auto'
      };
      var spinner = new Spinner(opts);
      let selectedParticipant = null;

      function updateProgress(percent) {
        $('#progress-bar').css('width', percent+'%').text(percent+'%');
      }
      function showMask() {
        $('#page').addClass('disabled-form');
        $('#submit-mask').removeClass('hidden');
        updateProgress(0);
      }
      function hideMask() {
        $('#page').removeClass('disabled-form');
        $('#submit-mask').addClass('hidden');
      }
      function showResultLoading() { $('#result').addClass('result-loading'); }
      function hideResultLoading() { $('#result').removeClass('result-loading'); }

      function getCurrentYear() { return new Date().getFullYear(); }

      function query() {
        $("#result").empty();
        $("#badgeCode").empty();
        const now = new Date();
        //let month = $('#month option:selected').val();
        const currentMonth = String(now.getMonth()+1).padStart(2,'0');
        showMask();
        ajaxRequest(
          "GET",
          server + "/surveyResult/participants?yearMonth=" + getCurrentYear() + "-" + currentMonth,
          null,
          true,
          queryByMonthOnSuccess,
          onError
        );
      }

      function queryByMonthOnSuccess(response) {
        let code = response.code;
        let dataArray = response.data;
        if (code == 0) {
          spinner.spin();
          $("#badgeCode").empty();
          if (dataArray.length == 0) {
            $("#badgeCode").append("There is no questionnaire information for this month.");
          } else {
            dataArray.forEach(item => {
              let fullName = item.fullName;
              let omitName = item.omitName;
              let cc = item.cc;
              let btnClass = (fullName === selectedParticipant) ? "btn btn-primary selected-participant btn-participant" : "btn btn-secondary btn-participant";
              let buttonHtml = `<button onclick="getSurveyResult(this)" value="${fullName}" class="${btnClass}">${omitName}<span class="spanBadge badge bg-indigo text-indigo-fg badge-pill">${cc}</span></button>`;
              $("#badgeCode").append(buttonHtml);
            });
          }
          hideMask();
        }
      }

      function getSurveyResult(button) {
        selectedParticipant = $(button).val();
        $("#badgeCode button").removeClass("selected-participant btn-primary").addClass("btn-secondary");
        $(button).addClass("selected-participant btn-primary").removeClass("btn-secondary");
        //let month = $('#month option:selected').val();
         const now = new Date();
        //let month = $('#month option:selected').val();
        const month = String(now.getMonth()+1).padStart(2,'0');
        loadData(getCurrentYear() + '-' + month, selectedParticipant);
      }

      function loadData(yearMonth, participants) {
        showResultLoading();
        ajaxRequest(
          "GET",
          server + "/surveyResult/query4?yearMonth=" + yearMonth + "&participants=" + encodeURIComponent(participants),
          null,
          true,
          queryByParticipantsOnSuccess,
          onError
        );
      }

      function onError(jqXHR, textStatus, errorThrown) {
        hideMask();
        Swal.fire('Error', textStatus, 'error');
      }

      function queryByParticipantsOnSuccess(response) {
        if (response.code !== 0) return;
        spinner.spin();
        let timesArray = response.data.survey;
        let name = response.data.name;
        let opDate = response.data.opDate;

        $("#result").empty();

        let headHtml = `<thead><tr><th></th><th colspan=3 style="color:black;font-size:14px;font-weight:600;text-align:right;">Name:&nbsp;${name}</th><th colspan=7 style="color:black;font-size:14px;font-weight:600;">Review Date:&nbsp;${opDate}</th><th></th></tr></thead>`;
        let divCode = `<div class='col-12'><div class='card'><div class='table-responsive'><table id='card' class='table'>${headHtml}<tbody>`;
        let tbodyHtml = "";
        let totals = [0,0,0,0,0];

        timesArray.forEach(item => {
          let arr = assemble(item.answer);
          arr.forEach((v,i)=> totals[i] += Number(v.split("-")[0]));
          tbodyHtml += `<tr><td colspan=12>${item.title}</br>${item.title_ks}</td></tr>`;
          tbodyHtml += `<tr><td style='padding-left:5px;width:0px'></td>${arr.map(v=>`<td>${v}</td>`).join('')}<td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
        });

        tbodyHtml += `<tr><td style='padding-left:5px;width:0px'>Mark</td><td style='color:red;font-weight:600;'>5</td><td style='color:red;font-weight:600;'>4</td><td style='color:red;font-weight:600;'>3</td><td style='color:red;font-weight:600;'>2</td><td style='color:red;font-weight:600;'>1</td><td colspan=6></td></tr>`;

        let scores = totals.map((v,i)=> v*(5-i));
        let totalScore = scores.reduce((a,b)=>a+b,0);
        tbodyHtml += `<tr><td style='padding-left:5px;width:0px;font-size:18px;font-weight:800;'>Total</td><td style='font-weight:800;'>${scores[0]}</td><td style='font-weight:800;'>${scores[1]}</td><td style='font-weight:800;'>${scores[2]}</td><td style='font-weight:800;'>${scores[3]}</td><td style='font-weight:800;'>${scores[4]}</td><td style='font-size:18px;font-weight:800;'>${totalScore}</td></tr>`;

        divCode += tbodyHtml + "</tbody></table></div></div></div>";
        $("#result").append(divCode);
        $(".badge-pill").addClass("spanBadge badge bg-indigo text-indigo-fg badge-notification badge-pill");
        hideResultLoading();
      }

      function assemble(str) {
        let emptyArray = Array(5).fill("");
        let array = str.split("_");
        for (let item of array) {
          let score = item.split("-")[1];
          switch(score) {
            case "5": emptyArray[0]=item; break;
            case "4": emptyArray[1]=item; break;
            case "3": emptyArray[2]=item; break;
            case "2": emptyArray[3]=item; break;
            case "1": emptyArray[4]=item; break;
          }
        }
        let lowStr = str.toLowerCase();
        if (!lowStr.includes("5")) emptyArray[0]="0-5";
        if (!lowStr.includes("4")) emptyArray[1]="0-4";
        if (!lowStr.includes("3")) emptyArray[2]="0-3";
        if (!lowStr.includes("2")) emptyArray[3]="0-2";
        if (!lowStr.includes("1")) emptyArray[4]="0-1";
        return emptyArray;
      }

      function deleteSurvey() {
        Swal.fire({
          title: 'Delete Survey Result',
          input: 'text',
          inputLabel: 'Enter participant name (optional)',
          inputPlaceholder: 'Participant name',
          showCancelButton: true,
          confirmButtonText: 'Delete',
          preConfirm: (name) => Promise.resolve(name || '')
        }).then((result) => {
          if (!result.isConfirmed) return;
          let name = result.value;
          Swal.fire({
            title: 'Are you sure?',
            text: `You are about to delete survey results for "${name || 'ALL'}"`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete',
            cancelButtonText: 'Cancel'
          }).then((confirmResult) => {
            if (!confirmResult.isConfirmed) return;
            showMask(); updateProgress(0);
            ajaxRequest(
              "GET",
              server + "/surveyResult/deleteSurveyResult?name=" + encodeURIComponent(name),
              null,
              true,
              function(resp){
                hideMask();
                if(resp.code===0){
                  Swal.fire('Deleted!', 'Survey result has been deleted.', 'success');
                  query();
                } else {
                  Swal.fire('Error', resp.message, 'error');
                }
              },
              function(jqXHR,textStatus){ hideMask(); Swal.fire('Error',textStatus,'error'); }
            );
          });
        });
      }

      function generatePDF() {
        var element = document.getElementById('card');
        html2canvas(element).then(function(canvas){
          var imgData = canvas.toDataURL('image/png');
          var doc = new jsPDF('p','mm','a4');
          var imgWidth = canvas.width / 2.54;
          var imgHeight = canvas.height / 2.54;
          var pageHeight = doc.internal.pageSize.height;
          var pdfHeight = Math.min(imgHeight, pageHeight - 10);

          var img = new Image();
          img.src = imgData;
          img.onload = function() {
            var yPos = 0;
            while(yPos<imgHeight){
              doc.addImage(imgData,'PNG',5,yPos,imgWidth,pdfHeight);
              yPos += pdfHeight;
              if(yPos<imgHeight) doc.addPage();
            }
            doc.save('Test.pdf');
          };
        });
      }

      // 页面加载时自动查询本月数据
      $(document).ready(function(){
        //const now = new Date();
        //const currentMonth = String(now.getMonth()+1).padStart(2,'0');
        //$('#month').val(currentMonth);
        query();
      });
    </script>

    <script src="./dist/js/tabler.min.js?1692870487" defer></script>
  </body>
</html>
