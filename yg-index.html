<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OZHouse Questionnaires</title>

  <link href="./dist/css/tabler.min.css" rel="stylesheet"/>
  <link href="./dist/css/demo.min.css" rel="stylesheet"/>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="dist/js/sweetalert2.all.min.js"></script>
  <script src="dist/js/common.js"></script>

  <style>
    .mask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto; /* 遮罩可阻止点击穿透 */
    }
    .mask-box {
      width: 320px;
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      text-align: center;
    }
    .hidden { display: none; }

    /* 当页面提交中，禁用整个页面的控件 */
    body.submitting *:not(#submit-mask) {
      pointer-events: none; /* 禁止鼠标点击、输入 */
      user-select: none;    /* 禁止文字选中 */
      opacity: 0.6;         /* 页面控件半透明提示 */
    }
  </style>
</head>

<body>
<div class="page">
  <div class="page-wrapper">
    <div class="page-body container-xl">
      <div class="card">
        <div class="card-header text-center">
          <h1 class="card-title">Questionnaires</h1>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">SELECT LANGUAGE</label>
            <select class="form-select" id="select-countries">
              <option value="1">EN</option>
              <option value="2">Burmese</option>
            </select>
          </div>

          <div class="mb-3">
            <div class="form-label required">PLEASE SELECT ONE NAME</div>
            <div id="employee"></div>
          </div>

          <hr/>
          <div id="result"></div>
        </div>
        <div class="card-footer text-center">
          <button id="submitBtn" class="btn btn-primary btn-lg">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 遮罩 + 进度条 -->
<div id="submit-mask" class="mask hidden">
  <div class="mask-box">
    <div class="mb-2">Submitting...</div>
    <div class="progress">
      <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
    </div>
  </div>
</div>

<script>
let questionNum = 0;
let submitting = false;

function updateProgress(percent){
  const bar = document.getElementById('progress-bar');
  bar.style.width = percent + '%';
  bar.innerText = percent + '%';
}

function showMask(){
  updateProgress(0);
  document.getElementById('submit-mask').classList.remove('hidden');
  document.body.classList.add('submitting'); // 禁止整个页面操作
}

function hideMask(){
  document.getElementById('submit-mask').classList.add('hidden');
  document.body.classList.remove('submitting'); // 恢复操作
}

function loadEmployee(){
  $('#employee').empty();
  ajaxRequest('GET', server+'/employee/selectLisYg', null, true, res => {
    const html = res.data.map((e,i)=>
      `<label class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="emp" ${i===0?'checked':''}>
        <span class="form-check-label">${e.name}</span>
      </label>`
    ).join('');
    $('#employee').html(html);
  });
}

function loadQuestions(lang){
  $('#result').empty();
  ajaxRequest('GET', server+`/question/answer/query-yg?countries=${lang}`, null, true, res => {
    questionNum = res.data.length;
    const html = res.data.map(q => {
      const answers = q.content.split('，').map(a=>{
        const [k,v] = a.split('-');
        return `<label class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="q${q.qid}" value="${k}">
          <span class="form-check-label">${v}</span>
        </label>`;
      }).join('');
      return `<div class="mb-3"><p class="form-label required" data-qid="${q.qid}">${q.title}</p>${answers}</div>`;
    }).join('');
    $('#result').html(html);
  });
}

// 切换语言
$('#select-countries').change(e => loadQuestions(e.target.value));

// 提交按钮点击
$('#submitBtn').click(async ()=>{
  if(submitting) return; // 已提交中直接返回

  const answers = $('#result input[type=radio]:checked').map((_,e)=>e.value).get();
  if(answers.length !== questionNum){
    Swal.fire('Tips','You have unanswered questions','info');
    return;
  }

  submitting = true;
  $('#submitBtn').prop('disabled', true); // 禁用按钮
  showMask();

  const qids = $('#result p[data-qid]').map((_,e)=>e.dataset.qid).get();
  const participant = $('input[name=emp]:checked').next().text();
  const payload = { participants: participant, qid: qids.join(','), anwser: answers.join(',') };

  let percent = 0;
  const timer = setInterval(()=>{
    percent = Math.min(percent+10,90);
    updateProgress(percent);
  },300);

  ajaxRequest('POST', server+'/surveyResult/addYg', JSON.stringify(payload), true,
    res=>{
      clearInterval(timer);
      updateProgress(100);
      setTimeout(()=>{
        hideMask();
        submitting = false;
        $('#submitBtn').prop('disabled', false);
        Swal.fire('Success','Submit Successfully','success').then(()=>location.reload());
      },500);
    },
    ()=>{
      clearInterval(timer);
      hideMask();
      submitting = false;
      $('#submitBtn').prop('disabled', false);
      Swal.fire('Error','Submit failed','error');
    }
  );
});

// 初始化
loadEmployee();
loadQuestions(1);
</script>
</body>
</html>
